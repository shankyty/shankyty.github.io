
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://example.com/booknotes/system-design-interview/chapter26/">
      
      
        <link rel="prev" href="../chapter25/">
      
      
        <link rel="next" href="../chapter27/">
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.19">
    
    
      
        <title>Real-time Gaming Leaderboard - Notes</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.7e37652d.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#real-time-gaming-leaderboard" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Notes" class="md-header__button md-logo" aria-label="Notes" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Notes
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Real-time Gaming Leaderboard
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Notes" class="md-nav__button md-logo" aria-label="Notes" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Notes
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Welcome to My Notes
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Booknotes
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Booknotes
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1" >
        
          
          <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    System design
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1">
            <span class="md-nav__icon md-icon"></span>
            System design
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../system-design/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    System Design
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_2" >
        
          
          <label class="md-nav__link" for="__nav_2_1_2" id="__nav_2_1_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Understanding distributed systems
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_1_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_2">
            <span class="md-nav__icon md-icon"></span>
            Understanding distributed systems
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../system-design/understanding-distributed-systems/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Index
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../system-design/understanding-distributed-systems/part00/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Introduction
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../system-design/understanding-distributed-systems/part01/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Communication
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../system-design/understanding-distributed-systems/part02/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Coordination
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../system-design/understanding-distributed-systems/part03/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Scalability
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../system-design/understanding-distributed-systems/part04/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Resiliency
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../system-design/understanding-distributed-systems/part05/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Maintainability
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    System design interview
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            System design interview
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    System Design Interview - An Insider's Guide (vol 1 &amp; 2)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter02/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Scale From Zero to Millions of Users
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter03/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Back-of-the-envelope Estimation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter04/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    A Framework for System Design Interviews
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter05/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Design a Rate Limiter
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter06/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Design Consistent Hashing
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter07/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Design a Key-Value Store
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter08/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Design a Unique ID Generator in Distributed Systems
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter09/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Design a URL Shortener
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter10/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Design a Web Crawler
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter11/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Design a Notification System
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter12/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Design a News Feed System
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter13/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Design a Chat System
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter14/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Design A Search Autocomplete System
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter15/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Design YouTube
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter16/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Design Google Drive
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter17/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Proximity Service
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter18/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Nearby Friends
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter19/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Google Maps
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter20/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Distributed Message Queue
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter21/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Metrics Monitoring and Alerting System
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter22/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Ad Click Event Aggregation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter23/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Hotel Reservation System
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter24/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Distributed Email Service
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter25/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    S3-like Object Storage
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Real-time Gaming Leaderboard
    
  </span>
  

      </a>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter27/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Payment System
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter28/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Digital Wallet
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter29/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Stock Exchange
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="real-time-gaming-leaderboard">Real-time Gaming Leaderboard</h1>
<p>We are going to design a leaderboard for an online mobile game:
<img alt="leaderboard" src="images/leaderboard.png" /></p>
<h1 id="step-1-understand-the-problem-and-establish-design-scope">Step 1 - Understand the Problem and Establish Design Scope</h1>
<ul>
<li>C: How is the score calculated for the leaderboard?</li>
<li>I: User gets a point whenever they win a match.</li>
<li>C: Are all players included in the leaderboard?</li>
<li>I: Yes</li>
<li>C: Is there a time segment, associated with the leaderboard?</li>
<li>I: Each month, a new tournament starts which starts a new leaderboard.</li>
<li>C: Can we assume we only care about top 10 users?</li>
<li>I: We want to display top 10 users, along with position of specific user. If time permits, we can discuss showing users around particular user in the leaderboard.</li>
<li>C: How many users are in a tournament?</li>
<li>I: 5mil DAU and 25mil MAU</li>
<li>C: How many matches are played on average during a tournament?</li>
<li>I: Each player plays 10 matches per day on average</li>
<li>C: How do we determine the rank if two players have the same score?</li>
<li>I: Their rank is the same in that case. If time permits, we can discuss breaking ties.</li>
<li>C: Does the leaderboard need to be real-time?</li>
<li>I: Yes, we want to present real-time results or as close as possible to real-time. It is not okay to present batched result history.</li>
</ul>
<h2 id="functional-requirements">Functional requirements</h2>
<ul>
<li>Display top 10 players on leaderboard</li>
<li>Show a user's specific rank</li>
<li>Display users which are four places above and below given user (bonus)</li>
</ul>
<h2 id="non-functional-requirements">Non-functional requirements</h2>
<ul>
<li>Real-time updates on scores</li>
<li>Score update is reflected on the leaderboard in real-time</li>
<li>General scalability, availability, reliability</li>
</ul>
<h2 id="back-of-the-envelope-estimation">Back-of-the-envelope estimation</h2>
<p>With 50mil DAU, if the game has an even distribution of players during a 24h period, we'd have an average of 50 users per second.
However, since distribution is typically uneven, we can estimate that the peak online users would be 250 users per second.</p>
<p>QPS for users scoring a point - given 10 games per day on average, 50 users/s * 10 = 500 QPS. Peak QPS = 2500.</p>
<p>QPS for fetching the top 10 leaderboard - assuming users open that once a day on average, QPS is 50.</p>
<h1 id="step-2-propose-high-level-design-and-get-buy-in">Step 2 - Propose High-Level Design and Get Buy-In</h1>
<h2 id="api-design">API Design</h2>
<p>The first API we need is one to update a user's score:
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>POST /v1/scores
</code></pre></div></p>
<p>This API takes two params - <code>user_id</code> and <code>points</code> scored for winning a game.</p>
<p>This API should only be accessible to game servers, not end clients.</p>
<p>Next one is for getting the top 10 players of the leaderboard:
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>GET /v1/scores
</code></pre></div></p>
<p>Example response:
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>{
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>  &quot;data&quot;: [
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>    {
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>      &quot;user_id&quot;: &quot;user_id1&quot;,
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a>      &quot;user_name&quot;: &quot;alice&quot;,
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>      &quot;rank&quot;: 1,
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>      &quot;score&quot;: 12543
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>    },
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a>    {
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a>      &quot;user_id&quot;: &quot;user_id2&quot;,
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>      &quot;user_name&quot;: &quot;bob&quot;,
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a>      &quot;rank&quot;: 2,
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a>      &quot;score&quot;: 11500
<a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a>    }
<a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a>  ],
<a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a>  ...
<a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a>  &quot;total&quot;: 10
<a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a>}
</code></pre></div></p>
<p>You can also get the score of a particular user:
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>GET /v1/scores/{:user_id}
</code></pre></div></p>
<p>Example response:
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>{
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>    &quot;user_info&quot;: {
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>        &quot;user_id&quot;: &quot;user5&quot;,
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>        &quot;score&quot;: 1000,
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>        &quot;rank&quot;: 6,
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>    }
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>}
</code></pre></div></p>
<h2 id="high-level-architecture">High-level architecture</h2>
<p><img alt="high-level-architecture" src="images/high-level-architecture.png" />
 * When a player wins a game, client sends a request to the game service
 * Game service validates if win is valid and calls the leaderboard service to update the player's score
 * Leaderboard service updates the user's score in the leaderboard store
 * Player makes a call to leaderboard service to fetch leaderboard data, eg top 10 players and given player's rank</p>
<p>An alternative design which was considered is the client updating their score directly within the leaderboard service:
<img alt="alternative-design" src="images/alternative-design.png" /></p>
<p>This option is not secure as it's susceptible to man-in-the-middle attacks. Players can put a proxy and change their score as they please.</p>
<p>One additional caveat is that for games, where the game logic is managed by the server, cliets don't need to call the server explicitly to record their win. 
Servers do it automatically for them based on the game logic.</p>
<p>One additional consideration is whether we should put a message queue between the game server and the leaderboard service. This would be useful if other services are interested in game results, but that is not an explicit requirement in the interview so far, hence it's not included in the design:
<img alt="message-queue-based-comm" src="images/message-queue-based-comm.png" /></p>
<h2 id="data-models">Data models</h2>
<p>Let's discuss the options we have for storing leaderboard data - relational DBs, Redis, NoSQL.</p>
<p>The NoSQL solution is discussed in the deep dive section.</p>
<h3 id="relational-database-solution">Relational database solution</h3>
<p>If the scale doesn't matter and we don't have that many users, a relational DB serves our quite well.</p>
<p>We can start from a simple leaderboard table, one for each month (personal note - this doesn't make sense. You can just add a <code>month</code> column and avoid the headache of maintaining new tables each month): 
<img alt="leaderboard-table" src="images/leaderboard-table.png" /></p>
<p>There is additional data to include in there, but that is irrelevant to the queries we'd run, so it's omitted.</p>
<p>What happens when a user wins a point?
<img alt="user-wins-point" src="images/user-wins-point.png" /></p>
<p>If a user doesn't exist in the table yet, we need to insert them first:
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>INSERT INTO leaderboard (user_id, score) VALUES (&#39;mary1934&#39;, 1);
</code></pre></div></p>
<p>On subsequent calls, we'd just update their score:
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>UPDATE leaderboard set score=score + 1 where user_id=&#39;mary1934&#39;;
</code></pre></div></p>
<p>How do we find the top players of a leaderboard?
<img alt="find-leaderboard-position" src="images/find-leaderboard-position.png" /></p>
<p>We can run the following query:
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>SELECT (@rownum := @rownum + 1) AS rank, user_id, score
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>FROM leaderboard
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>ORDER BY score DESC;
</code></pre></div></p>
<p>This is not performant though as it makes a table scan to order all records in the database table.</p>
<p>We can optimize it by adding an index on <code>score</code> and using the <code>LIMIT</code> operation to avoid scanning everything:
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>SELECT (@rownum := @rownum + 1) AS rank, user_id, score
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>FROM leaderboard
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>ORDER BY score DESC
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>LIMIT 10;
</code></pre></div></p>
<p>This approach, however, doesn't scale well if the user is not at the top of the leaderboard and you'd want to locate their rank.</p>
<h3 id="redis-solution">Redis solution</h3>
<p>We want to find a solution, which works well even for millions of players without having to fallback on complex database queries.</p>
<p>Redis is an in-memory data store, which is fast as it works in-memory and has a suitable data structure to serve our needs - sorted set.</p>
<p>A sorted set is a data structure similar to sets in programming languages, which allows you to keep a data structure sorted by a given criteria.
Internally, it is implemented using a hash-map to maintain mapping between key (user_id) and value (score) and a skip list which maps scores to users in sorted order:
<img alt="sorted-set" src="images/sorted-set.png" /></p>
<p>How does a skip list work?
 * It is a linked list which allows for fast search
 * It consists of a sorted linked list and multi-level indexes
<img alt="skip-list" src="images/skip-list.png" /></p>
<p>This structure enables us to quickly search for specific values when the data set is large enough.
In the example below (64 nodes), it requires traversing 62 nodes in a base linked list to find the given value and 11 nodes in the skip-list case:
<img alt="skip-list-performance" src="images/skip-list-performance.png" /></p>
<p>Sorted sets are more performant than relational databases as the data is kept sorted at all times at the price of O(logN) add and find operation.</p>
<p>In contract, here's an example nested query we need to run to find the rank of a given user in a relational DB:
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>SELECT *,(SELECT COUNT(*) FROM leaderboard lb2
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>WHERE lb2.score &gt;= lb1.score) RANK
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>FROM leaderboard lb1
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>WHERE lb1.user_id = {:user_id};
</code></pre></div></p>
<p>What operations do we need to operate our leaderboard in Redis?
 * <code>ZADD</code> - insert the user into the set if they don't exist. Otherwise, update the score. O(logN) time complexity.
 * <code>ZINCRBY</code> - increment the score of a user by given amount. If user doesn't exist, score starts at zero. O(logN) time complexity.
 * <code>ZRANGE/ZREVRANGE</code> - fetch a range of users, sorted by their score. We can specify order (ASC/DESC), offset and result size. O(logN+M) time complexity where M is result size.
 * <code>ZRANK/ZREVRANK</code> - Fetch the position (rank) of given user in ASC/DESC order. O(logN) time complexity.</p>
<p>What happens when a user scores a point?
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>ZINCRBY leaderboard_feb_2021 1 &#39;mary1934&#39;
</code></pre></div></p>
<p>There's a new leaderboard created every month while old ones are moved to historical storage.</p>
<p>What happens when a user fetches top 10 players?
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>ZREVRANGE leaderboard_feb_2021 0 9 WITHSCORES
</code></pre></div></p>
<p>Example result:
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>[(user2,score2),(user1,score1),(user5,score5)...]
</code></pre></div></p>
<p>What about user fetching their leaderboard position?
<img alt="leaderboard-position-of-user" src="images/leaderboard-position-of-user.png" /></p>
<p>This can be easily achieved by the following query, given that we know a user's leaderboard position:
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>ZREVRANGE leaderboard_feb_2021 357 365
</code></pre></div></p>
<p>A user's position can be fetched using <code>ZREVRANK &lt;user-id&gt;</code>.</p>
<p>Let's explore what our storage requirements are:
 * Assuming worst-case scenario of all 25mil MAU participating in the game for a given month
 * ID is 24-character string and score is 16-bit integer, we need 26 bytes * 25mil = ~650MB of storage
 * Even if we double the storage cost due to the overhead of the skip list, this would still easily fit in a modern redis cluster</p>
<p>Another non-functional requirement to consider is supporting 2500 updates per second. This is well within a single Redis server's capabilities.</p>
<p>Additional caveats:
 * We can spin up a Redis replica to avoid losing data when a redis server crashes
 * We can still leverage Redis persistence to not lose data in the event of a crash
 * We'll need two supporting tables in MySQL to fetch user details such as username, display name, etc as well as store when eg a user won a game
 * The second table in MySQL can be used to reconstruct leaderboard when there is an infrastructure failure
 * As a small performance optimization, we could cache the user details of top 10 players as they'd be frequently accessed</p>
<h1 id="step-3-design-deep-dive">Step 3 - Design Deep Dive</h1>
<h2 id="to-use-a-cloud-provider-or-not">To use a cloud provider or not</h2>
<p>We can either choose to deploy and manage our own services or use a cloud provider to manage them for us.</p>
<p>If we choose to manage the services our selves, we'll use redis for leaderboard data, mysql for user profile and potentially a cache for user profile if we want to scale the database:
<img alt="manage-services-ourselves" src="images/manage-services-ourselves.png" /></p>
<p>Alternatively, we could use cloud offerings to manage a lot of the services for us. For example, we can use AWS API Gateway to route API calls to AWS Lambda functions:
<img alt="api-gateway-mapping" src="images/api-gateway-mapping.png" /></p>
<p>AWS Lambda enables us to run code without managing or provisioning servers ourselves. It runs only when needed and scales automatically.</p>
<p>Exmaple user scoring a point:
<img alt="user-scoring-point-lambda" src="images/user-scoring-point-lambda.png" /></p>
<p>Example user retrieving leaderboard:
<img alt="user-retrieve-leaderboard" src="images/user-retrieve-leaderboard.png" /></p>
<p>Lambdas are an implementation of a serverless architecture. We don't need to manage scaling and environment setup.</p>
<p>Author recommends going with this approach if we build the game from the ground up.</p>
<h2 id="scaling-redis">Scaling Redis</h2>
<p>With 5mil DAU, we can get away with a single Redis instance from both a storage and QPS perspective.</p>
<p>However, if we imagine userbase grows 10x to 500mil DAU, then we'd need 65gb for storage and QPS goes to 250k.</p>
<p>Such scale would require sharding.</p>
<p>One way to achieve it is by range-partitioning the data:
<img alt="range-partition" src="images/range-partition.png" /></p>
<p>In this example, we'll shard based on user's score. We'll maintain the mapping between user_id and shard in application code.
We can do that either via MySQL or another cache for the mapping itself.</p>
<p>To fetch the top 10 players, we'd query the shard with the highest scores (<code>[900-1000]</code>).</p>
<p>To fetch a user's rank, we'll need to calculate the rank within the user's shard and add up all users with higher scores in other shards.
The latter is a O(1) operation as total records per shard can quickly be accessed via the info keyspace command.</p>
<p>Alternatively, we can use hash partitioning via Redis Cluster. It is a proxy which distributes data across redis nodes based on partitioning similar to consistent hashing, but not exactly the same:
<img alt="hash-partition" src="images/hash-partition.png" /></p>
<p>Calculating the top 10 players is challenging with this setup. We'll need to get the top 10 players of each shard and merge the results in the application:
<img alt="top-10-players-calculation" src="images/top-10-players-calculation.png" /></p>
<p>There are some limitations with the hash partitioning:
 * If we need to fetch top K users, where K is high, latency can increase as we'll need to fetch a lot of data from all the shards
 * Latency increases as the number of partitions grows
 * There is no straightforward approach to determine a user's rank</p>
<p>Due to all this, the author leans towards using fixed partitions for this problem.</p>
<p>Other caveats:
 * A best practice is to allocate twice as much memory as required for write-heavy redis nodes to accommodate snapshots if required
 * We can use a tool called Redis-benchmark to track the performance of a redis setup and make data-driven decisions</p>
<h2 id="alternative-solution-nosql">Alternative solution: NoSQL</h2>
<p>An alternative solution to consider is using an appropriate NoSQL database optimized for:
 * heavy writes
 * effectively sorting items within the same partition by score</p>
<p>DynamoDB, Cassandra or MongoDB are all good fits.</p>
<p>In this chapter, the author has decided to use DynamoDB. It is a fully-managed NoSQL database, which offers reliable performance and great scalability.
It also enables usage of global secondary indexes when we need to query fields not part of the primary key.
<img alt="dynamo-db" src="images/dynamo-db.png" /></p>
<p>Let's start from a table for storing a leaderboard for a chess game:
<img alt="chess-game-leaderboard-table-1" src="images/chess-game-leaderboard-table-1.png" /></p>
<p>This works well, but doesn't scale well if we need to query anything by score. Hence, we can put the score as a sort key:
<img alt="chess-game-leaderboard-table-2" src="images/chess-game-leaderboard-table-2.png" /></p>
<p>Another problem with this design is that we're partitioning by month. This leads to a hotspot partition as the latest month will be unevenly accessed compared to the others.</p>
<p>We could use a technique called write sharding, where we append a partition number for each key, calculated via <code>user_id % num_partitions</code>:
<img alt="chess-game-leaderboard-table-3" src="images/chess-game-leaderboard-table-3.png" /></p>
<p>An important trade-off to consider is how many partitions we should use:
 * The more partitions there are, the higher the write scalability
 * However, read scalability suffers as we need to query more partitions to collect aggregate results</p>
<p>Using this approach requires that we use the "scatter-gather" technique we saw earlier, which grows in time complexity as we add more partitions:
<img alt="scatter-gather-2" src="images/scatter-gather-2.png" /></p>
<p>To make a good evaluation on the number of partitions, we'd need to do some benchmarking.</p>
<p>This NoSQL approach still has one major downside - it is hard to calculate the specific rank of a user.</p>
<p>If we have sufficient scale to require us to shard, we could then perhaps tell users what "percentile" of scores they're in.</p>
<p>A cron job can periodically run to analyze score distributions, based on which a user's percentile is determined, eg:
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>10th percentile = score &lt; 100
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>20th percentile = score &lt; 500
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>...
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>90th percentile = score &lt; 6500
</code></pre></div></p>
<h1 id="step-4-wrap-up">Step 4 - Wrap Up</h1>
<p>Other things to discuss if time permits:
 * Faster retrieval - We can cache the user object via a Redis hash with mapping <code>user_id -&gt; user object</code>. This enables faster retrieval vs. querying the database.
 * Breaking ties - When two players have the same score, we can break the tie by sorting them based on last played game.
 * System failure recovery - In the event of a large-scale Redis outage, we can recreate the leaderboard by going through the MySQL WAL entries and recreate it via an ad-hoc script</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": [], "search": "../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.92b07e13.min.js"></script>
      
    
  </body>
</html>