
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://example.com/booknotes/system-design-interview/chapter16/">
      
      
        <link rel="prev" href="../chapter15/">
      
      
        <link rel="next" href="../chapter17/">
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.19">
    
    
      
        <title>Design Google Drive - Notes</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.7e37652d.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#design-google-drive" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Notes" class="md-header__button md-logo" aria-label="Notes" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Notes
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Design Google Drive
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Notes" class="md-nav__button md-logo" aria-label="Notes" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Notes
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Welcome to My Notes
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Booknotes
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Booknotes
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1" >
        
          
          <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    System design
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1">
            <span class="md-nav__icon md-icon"></span>
            System design
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../system-design/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    System Design
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_2" >
        
          
          <label class="md-nav__link" for="__nav_2_1_2" id="__nav_2_1_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Understanding distributed systems
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_1_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_2">
            <span class="md-nav__icon md-icon"></span>
            Understanding distributed systems
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../system-design/understanding-distributed-systems/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Index
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../system-design/understanding-distributed-systems/part00/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Introduction
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../system-design/understanding-distributed-systems/part01/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Communication
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../system-design/understanding-distributed-systems/part02/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Coordination
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../system-design/understanding-distributed-systems/part03/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Scalability
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../system-design/understanding-distributed-systems/part04/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Resiliency
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../system-design/understanding-distributed-systems/part05/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Maintainability
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    System design interview
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            System design interview
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    System Design Interview - An Insider's Guide (vol 1 &amp; 2)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter02/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Scale From Zero to Millions of Users
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter03/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Back-of-the-envelope Estimation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter04/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    A Framework for System Design Interviews
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter05/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Design a Rate Limiter
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter06/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Design Consistent Hashing
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter07/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Design a Key-Value Store
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter08/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Design a Unique ID Generator in Distributed Systems
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter09/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Design a URL Shortener
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter10/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Design a Web Crawler
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter11/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Design a Notification System
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter12/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Design a News Feed System
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter13/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Design a Chat System
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter14/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Design A Search Autocomplete System
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter15/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Design YouTube
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Design Google Drive
    
  </span>
  

      </a>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter17/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Proximity Service
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter18/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Nearby Friends
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter19/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Google Maps
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter20/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Distributed Message Queue
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter21/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Metrics Monitoring and Alerting System
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter22/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Ad Click Event Aggregation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter23/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Hotel Reservation System
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter24/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Distributed Email Service
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter25/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    S3-like Object Storage
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter26/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Real-time Gaming Leaderboard
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter27/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Payment System
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter28/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Digital Wallet
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter29/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Stock Exchange
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="design-google-drive">Design Google Drive</h1>
<p>Google Drive is a cloud file storage product, which helps you store documents, videos, etc from the cloud.</p>
<p>You can access them from any device and share them with friends and family.</p>
<h1 id="step-1-understand-the-problem-and-establish-design-scope">Step 1 - Understand the problem and establish design scope</h1>
<ul>
<li>C: What are most important features?</li>
<li>I: Upload/download files, file sync and notifications</li>
<li>C: Mobile or web?</li>
<li>I: Both</li>
<li>C: What are the supported file formats?</li>
<li>I: Any file type</li>
<li>C: Do files need to be encrypted?</li>
<li>I: Yes, files in storage need to be encrypted</li>
<li>C: Is the a file size limit?</li>
<li>I: Yes, files need to be 10 gb or smaller</li>
<li>C: How many users does the app have?</li>
<li>I: 10mil DAU</li>
</ul>
<p>Features we'll focus on:
 * Adding files
 * Downloading files
 * Sync files across devices
 * See file revisions
 * Share file with friends
 * Send a notification when file is edited/deleted/shared</p>
<p>Features not discussed:
 * Collaborative editing</p>
<p>Non-functional requirements:
 * Reliability - data loss is unacceptable
 * Fast sync speed
 * Bandwidth usage - users will get unhappy if app consumes too much network traffic or battery
 * Scalability - we need to handle a lot of traffic
 * High availability - users should be able to use the system even when some services are down</p>
<h2 id="back-of-the-envelope-estimation">Back of the envelope estimation</h2>
<ul>
<li>Assume 50mil sign ups and 10mil DAU</li>
<li>Users get 10 gb free space</li>
<li>Users upload 2 files per day, average size is 500kb</li>
<li>1:1 read-write ratio</li>
<li>Total space allocated - 50mil * 10gb = 500pb</li>
<li>QPS for upload API - 10mil * 2 uploads / 24h / 3600s = ~240</li>
<li>Peak QPS = 480</li>
</ul>
<h1 id="step-2-propose-high-level-design-and-get-buy-in">Step 2 - propose high-level design and get buy-in</h1>
<p>In this chapter, we'll use a different approach than other ones - we'll start building the design from a single server and scale out from there.</p>
<p>We'll start from:
 * A web server to upload and download files
 * A database to keep track of metadata - user data, login info, files info, etc
 * Storage system to store the files</p>
<p>Example storage we could use:
<img alt="storage-example" src="images/storage-example.png" /></p>
<h2 id="apis">APIs</h2>
<p><strong>Upload file:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>https://api.example.com/files/upload?uploadType=resumable
</code></pre></div></p>
<p>This endpoint is used for uploading files with support for simple upload and resumable upload, which is used for large files.
Resumable upload is achieved by retrieving an upload URL and uploading the file while monitoring upload state. If disturbed, resume the upload.</p>
<p><strong>Download file:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>https://api.example.com/files/download
</code></pre></div></p>
<p>The payload specifies which file to download:
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>{
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>    &quot;path&quot;: &quot;/recipes/soup/best_soup.txt&quot;
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>}
</code></pre></div></p>
<p><strong>Get file revisions:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>https://api.example.com/files/list_revisions
</code></pre></div></p>
<p>params:
 * path to file for which revision history is retrieved
 * maximum number of revisions to return</p>
<p>All the APIs require authentication and use HTTPS.</p>
<h2 id="move-away-from-single-server">Move away from single server</h2>
<p>As more files are uploaded, at some point, you reach your storage's capacity.</p>
<p>One option to scale your storage server is by implementing sharing - each user's data is stored on separate servers:
<img alt="sharding-example" src="images/sharding-example.png" /></p>
<p>This solves your issue but you're still worried about potential data loss.</p>
<p>A good option to address that is to use an off-the-shelf solution like Amazon S3 which offers replication (same-region/cross-region) out of the box:
<img alt="amazon-s3" src="images/amazon-s3.png" /></p>
<p>Other areas you could improve:
 * Load balancing - this ensures evenly distributed network traffic to your web server replicas.
 * More web servers - with the advent of a load balancer, you can easily scale your web server layer by adding more servers.
 * Metadata database - move the database away from the server to avoid single points of failure. You can also setup replication and sharding to meet scalability requirements.
 * File storage - Amazon S3 for storage. To ensure availability and durability, files are replicated in two separate geographical regions.</p>
<p>Here's the updated design:
<img alt="updated-simple-design" src="images/updated-simple-design.png" /></p>
<h2 id="sync-conflicts">Sync conflicts</h2>
<p>Once the user base grows sufficiently, sync conflicts are unavoidable.</p>
<p>To address this, we can apply a strategy where the first who manages to modify a file first wins:
<img alt="sync-conflict" src="images/sync-conflict.png" /></p>
<p>What happens once you get a conflict? We generate a second version of the file which represents the alternative file version and it's up to the user to merge it:
<img alt="sync-conflict-example" src="images/sync-conflict-example.png" /></p>
<h2 id="high-level-design">High-level design</h2>
<p><img alt="high-level-design" src="images/high-level-design.png" />
 * User uses the application through a browser or a mobile app
 * Block servers upload files to cloud storage. Block storage is a technology which allows you to split a big file in blocks and store the blocks in a backing storage. Dropbox, for example, stores blocks of size 4mb.
 * Cloud storage - a file split into multiple blocks is stored in cloud storage
 * Cold storage - used for storing inactive files, infrequently accessed.
 * Load balancer - evenly distributes requests among API servers.
 * API servers - responsible for anything other than uploading files. Authentication, user profile management, updating file metadata, etc.
 * Metadata database - stores metadata about files uploaded to cloud storage.
 * Metadata cache - some of the metadata is cached for fast retrieval.
 * Notification service - Publisher/subscriber system which notifies users when a file is updated/edited/removed so that they can pull the latest changes.
 * Offline backup queue - used to queue file changes for users who are offline so that they can pull them once they come back online.</p>
<h1 id="step-3-design-deep-dive">Step 3 - Design deep dive</h1>
<p>Let's explore:
 * block servers
 * metadata database
 * upload/download flow
 * notification service
 * saving storage space
 * failure handling</p>
<h2 id="block-servers">Block servers</h2>
<p>For large files, it's infeasible to send the whole file on each update as it consumes a lot of bandwidth.</p>
<p>Two optimizations we're going to explore:
 * Delta sync - once a file is modified, only modified blocks are sent to the block servers instead of the whole file.
 * Compression - applying compression on blocks can significantly reduce data size. Different algorithms are suitable for different file types, eg for text files, we'll use gzip/bzip2.</p>
<p>Apart from splitting files in blocks, the block servers also apply encryption prior to storing files in file storage:
<img alt="block-servers-deep-dive" src="images/block-servers-deep-dive.png" /></p>
<p>Example delta sync:
<img alt="delta-sync" src="images/delta-sync.png" /></p>
<h2 id="high-consistency-requirement">High consistency requirement</h2>
<p>Our system requires strong consistency as it's unacceptable to show different versions of a file to different people.</p>
<p>This is mainly problematic when we use caches, in particular the metadata cache in our example. 
To sustain strong consistency, we need to:
 * keep cache master and replicas consistent
 * invalidate caches on database write</p>
<p>For the database, strong consistency is guaranteed as long as we use a relational database, which supports ACID (all typically do).</p>
<h2 id="metadata-database">Metadata database</h2>
<p>Here's a simplified table schema for the metadata db (only interesting fields are shown):
<img alt="metadata-db-deep-dive" src="images/metadata-db-deep-dive.png" />
 * User table contains basic information about the user such as username, email, profile photo, etc.
 * Device table stores device info. Push_id is used for sending push notifications. Users can have multiple devices.
 * Namespace - root directory of a user
 * File table stores everything related to a file
 * File_version stores the version history of a file. Existing fields are read-only to sustain file integrity.
 * Block - stores everything related to a file block. A file version can be reconstructed by joining all blocks in the correct version.</p>
<h2 id="upload-flow">Upload flow</h2>
<p><img alt="upload-flow" src="images/upload-flow.png" /></p>
<p>In the above flow, two requests are sent in parallel - updating file metadata and uploading the file to cloud storage.</p>
<p><strong>Add file metadata:</strong>
 * Client 1 sends request to update file metadata
 * New file metadata is stored and upload status is set to "pending"
 * Notify the notification service that a new file is being added.
 * Notification service notifies relevant clients about the file upload.</p>
<p><strong>Upload files to cloud storage:</strong>
 * Client 1 uploads file contents to block servers
 * Block servers chunk the file in blocks, compresses, encrypts them and uploads to cloud storage
 * Once file is uploaded, upload completion callback is triggered. Request is sent to API servers.
 * File status is changed to "uploaded" in Metadata DB.
 * Notification service is notified of file uploaded event and client 2 is notified about the new file.</p>
<h2 id="download-flow">Download flow</h2>
<p>Download flow is triggered when file is added or edited elsewhere. Client is notified via:
 * Notification if online
 * New changes are cached until user comes online if offline at the moment</p>
<p>Once a client is notified of the changes, it requests the file metadata and then downloads the blocks to reconstruct the file:
<img alt="download-flow" src="images/download-flow.png" />
 * Notification service informs client 2 of file changes
 * Client 2 fetches metadata from API servers
 * API servers fetch metadata from metadata DB
 * Client 2 gets the metadata
 * Once client receives the metadata, it sends requests to block servers to download blocks
 * Block servers download blocks from cloud storage and forwards them to the client</p>
<h2 id="notification-service">Notification service</h2>
<p>The notification service enables file changes to be communicated to clients as they happen.</p>
<p>Clients can communicate with the notification service via:
 * long polling (eg Dropbox uses this approach)
 * Web sockets - communication is persistent and bidirectional</p>
<p>Both options work well but we opt for long polling because:
 * Communication for notification service is not bi-directional. Server sends information to clients, not vice versa.
 * WebSocket is meant for real-time bidirectional communication. For google drive, notifications are sent infrequently.</p>
<p>With long polling, the client sends a request to the server which stays open until a change is received or timeout is reached. 
After that, a subsequent request is sent for next couple of changes.</p>
<h2 id="save-storage-space">Save storage space</h2>
<p>To support file version history and ensure reliability, multiple versions of a file are stored across multiple data centers.</p>
<p>Storage space can be filled up quickly. Three techniques can be applied to save storage space:
 * De-duplicate data blocks - if two blocks have the same hash, we can only store them once.
 * Adopt an intelligent backup strategy - set a limit on max version history and aggregate frequent edits into a single version.
 * Move infrequently accessed data to cold storage - eg Amazon S3 glacier is a good option for this, which is much cheaper than Amazon S3.</p>
<h2 id="failure-handling">Failure handling</h2>
<p>Some typical failures and how you could resolve them:
 * Load balancer failure - If a load balancer fails, a secondary becomes active and picks up the traffic.
 * Block server failure - If a block server fails, other replicas pick up the traffic and finish the job.
 * Cloud storage failure - S3 buckets are replicated across regions. If one region fails, traffic is redirected to the other one.
 * API server failure - Traffic is redirected to other service instances by the load balancer.
 * Metadata cache failure - Metadata cache servers are replicated multiple times. If one goes down, other nodes are still available.
 * Metadata DB failure - if master is down, promote one of the slaves to be master. If slave is down, use another one for read operations.
 * Notification service failure - If long polling connections are lost, clients reconnect to a different service replica, but reconnection of millions of clients will take some time.
 * Offline backup queue failure - Queues are replicated multiple times. If one queue fails, consumers need to resubscribe to the backup queue.</p>
<h1 id="step-4-wrap-up">Step 4 - Wrap up</h1>
<p>Properties of our Google Drive system design in a nutshell:
 * Strongly consistent
 * Low network bandwidth
 * Fast sync</p>
<p>Our design contains two flows - file upload and file sync.</p>
<p>If time permits, you could discuss alternative design approaches as there is no perfect design.
For example, we can upload blocks directly to cloud storage instead of going through block servers. </p>
<p>This is faster than our approach but has drawbacks:
 * Chunking, compression, encryption need to be implemented on different platforms (Android, iOS, Web). 
 * Client can be hacked so implementing encryption client-side is not ideal.</p>
<p>Another interesting discussion is moving online/offline logic to separate service so that other services can reuse it to implement interesting functionality.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": [], "search": "../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.92b07e13.min.js"></script>
      
    
  </body>
</html>