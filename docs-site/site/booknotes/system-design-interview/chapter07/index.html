
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://example.com/booknotes/system-design-interview/chapter07/">
      
      
        <link rel="prev" href="../chapter06/">
      
      
        <link rel="next" href="../chapter08/">
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.19">
    
    
      
        <title>Design a Key-Value Store - Notes</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.7e37652d.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#design-a-key-value-store" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Notes" class="md-header__button md-logo" aria-label="Notes" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Notes
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Design a Key-Value Store
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Notes" class="md-nav__button md-logo" aria-label="Notes" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Notes
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Welcome to My Notes
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Booknotes
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Booknotes
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1" >
        
          
          <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    System design
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1">
            <span class="md-nav__icon md-icon"></span>
            System design
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../system-design/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    System Design
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_2" >
        
          
          <label class="md-nav__link" for="__nav_2_1_2" id="__nav_2_1_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Understanding distributed systems
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_1_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_2">
            <span class="md-nav__icon md-icon"></span>
            Understanding distributed systems
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../system-design/understanding-distributed-systems/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Index
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../system-design/understanding-distributed-systems/part00/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Introduction
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../system-design/understanding-distributed-systems/part01/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Communication
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../system-design/understanding-distributed-systems/part02/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Coordination
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../system-design/understanding-distributed-systems/part03/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Scalability
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../system-design/understanding-distributed-systems/part04/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Resiliency
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../system-design/understanding-distributed-systems/part05/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Maintainability
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    System design interview
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            System design interview
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    System Design Interview - An Insider's Guide (vol 1 &amp; 2)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter02/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Scale From Zero to Millions of Users
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter03/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Back-of-the-envelope Estimation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter04/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    A Framework for System Design Interviews
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter05/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Design a Rate Limiter
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter06/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Design Consistent Hashing
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Design a Key-Value Store
    
  </span>
  

      </a>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter08/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Design a Unique ID Generator in Distributed Systems
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter09/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Design a URL Shortener
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter10/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Design a Web Crawler
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter11/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Design a Notification System
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter12/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Design a News Feed System
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter13/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Design a Chat System
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter14/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Design A Search Autocomplete System
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter15/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Design YouTube
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter16/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Design Google Drive
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter17/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Proximity Service
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter18/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Nearby Friends
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter19/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Google Maps
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter20/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Distributed Message Queue
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter21/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Metrics Monitoring and Alerting System
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter22/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Ad Click Event Aggregation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter23/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Hotel Reservation System
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter24/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Distributed Email Service
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter25/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    S3-like Object Storage
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter26/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Real-time Gaming Leaderboard
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter27/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Payment System
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter28/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Digital Wallet
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chapter29/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Stock Exchange
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="design-a-key-value-store">Design a Key-Value Store</h1>
<p>Key-value stores are a type of non-relational databases.
 * Each unique identifier is stored as a key with a value associated to it.
 * Keys must be unique and can be plain text or hashes.
 * Performance-wise, short keys work better.</p>
<p>Example keys:
 * plain-text - "last_logged_in_at"
 * hashed key - <code>253DDEC4</code></p>
<p>We're now about to design a key-value store which supports:
 * <code>put(key, value)</code> - insert <code>value</code> associated to <code>key</code>
 * <code>get(key)</code> - get <code>value</code> associated to <code>key</code></p>
<h1 id="understand-the-problem-and-establish-design-scope">Understand the problem and establish design scope</h1>
<blockquote>
<p>[!Important] 
- There's always a trade-off to be made between read/write and memory usage.
- Another trade-off is between consistency and availability.</p>
</blockquote>
<p>Here are the characteristics we're striving to achieve:
 * Key-value pair size is small - 10kb(what if this is 10MB,100MB ,what would change?)
 * We need to be able to store a lot of data.
 * High availability - system responds quickly even during failures.
 * High scalability - system can be scaled to support large data sets.
 * Automatic scaling - addition/deletion of servers should happen automatically based on traffic.
 * Tunable consistency.
 * Low latency.</p>
<h1 id="single-server-key-value-store">Single server key-value store</h1>
<p>Single server key-value stores are easy to develop.</p>
<p>We can just maintain an in-memory hash map which stores the key-value pairs.</p>
<p>Memory however, can be a bottleneck, as we can't fit everything in-memory. Here are our options to scale:
 * Data compression
 * Store only frequently used data in-memory. The rest store on disk.</p>
<p>Even with these optimizations, a single server can quickly reach its capacity.</p>
<h1 id="distributed-key-value-store">Distributed key-value store</h1>
<p>A distributed key-value store consists of a distributed hash table, which distributes keys across many nodes.</p>
<p>When developing a distributed data store, we need to factor in the CAP theorem</p>
<h2 id="cap-theorem">CAP Theorem</h2>
<p>This theorem states that a data store can't provide more than two of the following guarantees - consistency, availability, partition tolerance;
 * Consistency - all clients see the same data at the same time, no matter which node they're connected to.
 * Availability - all clients get a response, regardless of which node they connect to.
 * Partition tolerance - A network partition means that not all nodes within the cluster can communicate. Partition tolerance means that the system is operational even in such circumstances.
<img alt="cap-theorem" src="images/cap-theorem.png" /></p>
<p>A distributed system which supports consistency and availability cannot exist in the real world as network failures are inevitable.</p>
<p>Example distributed data store in an ideal situation:
<img alt="example-distributed-system" src="images/example-distributed-system.png" /></p>
<p>In the real world, a network partition can occur which hinders communication with eg node 3:
<img alt="network-partition-example" src="images/network-partition-example.png" /></p>
<p>If we favor consistency over availability, all write operations need to be blocked when the above scenario occurs.</p>
<p>If we favor availability on the other hand, the system continues accepting reads and writes, risking some clients receiving stale data.
When node 3 is back online, it will be re-synced with the latest data.</p>
<p>What you choose is something you need to clarify with the interviewer. There are different trade-offs with each option.</p>
<h1 id="system-components">System components</h1>
<p>This section goes through the key components needed to build a distributed key-value store.</p>
<h2 id="data-partition">Data partition</h2>
<p>For a large enough data set, it is infeasible to maintain it on a single server.
Hence, we can split the data into smaller partitions and distribute them across multiple nodes.</p>
<p>The challenge then, is to distribute data evenly and minimize data movement when the cluster is resized.</p>
<p>Both these problems can be addressed using consistent hashing (discussed in previous chapter):
 * Servers are put on a hash ring
 * Keys are hashed and put on the closest server in clockwise direction
<img alt="consistent-hashing" src="images/consistent-hashing.png" /></p>
<p>This has the following advantages:
 * Automatic scaling - servers can be added/removed at will with minimal impact on key location
 * Heterogeneity - servers with higher capacity can be allocated with more virtual nodes</p>
<h2 id="data-replication">Data replication</h2>
<p>To achieve high availability &amp; reliability, data needs to be replicated on multiple nodes.</p>
<p>We can achieve that by allocating a key to multiple nodes on the hash ring:
<img alt="data-replication" src="images/data-replication.png" /></p>
<blockquote>
<p>[!Note] 
One caveat to keep in mind that your key might get allocated to virtual nodes mapped to the same physical node. 
To avoid this, we can only choose unique physical nodes when replicating data.</p>
</blockquote>
<p>An additional reliability measure is to replicate data across multiple data centers as nodes in the same data centers can fail at the same time.</p>
<h2 id="consistency">Consistency</h2>
<p>Since data is replicated, it must be synchronized.</p>
<p>Quorum consensus can guarantee consistency for both reads and writes:
 * N - number of replicas
 * W - write quorum. Write operations must be acknowledged by W nodes.
 * R - read quorum. Read operations must be acknowledged by R nodes.
<img alt="write-quorum-example" src="images/write-quorum-example.png" /></p>
<p>The configuration of W and R is a trade-off between latency and consistency.
 * W = 1, R = 1 -&gt; low latency, eventual consistency
 * W + R &gt; N -&gt; strong consistency, high latency</p>
<p>Other configurations:
 * R = 1, W = N -&gt; strong consistency, fast reads, slow writes
 * R = N, W = 1 -&gt; strong consistency, fast writes, slow reads</p>
<h2 id="consistency-models">Consistency models</h2>
<p>There are multiple flavors of consistency we can tune our key-value store for:
 * Strong consistency - read operations return a value corresponding to most up-to-date data. Clients never see stale data.
 * Weak consistency - read operations might not see the most up-to-date data.
 * Eventual consistency - read operations might not see most up-to-date data, but with time, all keys will converge to the latest state.</p>
<p>Strong consistency usually means a node not accepting reads/writes until all nodes have acknowledged a write.
This is not ideal for highly available systems as it can block new operations.</p>
<p>Eventual consistency (supported by Cassandra and DynamoDB) is preferable for our key-value store.
This allows concurrent writes to enter the system and clients need to reconcile the data mismatches.</p>
<h2 id="inconsistency-resolution-versioning">Inconsistency resolution: versioning</h2>
<p>Replication provides high availability, but it leads to data inconsistencies across replicas.</p>
<p>Example inconsistency:
<img alt="inconsistency-example" src="images/inconsistency-example.png" /></p>
<p>This kind of inconsistency can be resolved using a versioning system using a vector clock.
A vector clock is a [server, version] pair, associated with a data item. Each time a data item is changed in a server, it's associated vector clock changes to [server_id, curr_version+1].</p>
<p>Example inconsistency resolution:
<img alt="inconsistency-resolution" src="images/inconsistency-resolution.png" />
 * Client writes D1, handled by Sx, which writes version [Sx, 1]
 * Another client reads D1, updates it and Sx increments version to [Sx, 2]
 * Client writes D3 based on D2 in Sy -&gt; D3([Sx, 2][Sy, 1]).
 * Simultaneously, another one writes D4 in Sz -&gt; D4([Sx, 2][Sz, 1])
 * A client reads D3 and D4 and detects a conflict. It makes a resolution and adds the updated version in Sx -&gt; D5([Sx, 3][Sy, 1][Sz, 1])</p>
<p>A conflict is detected by checking whether a version is an ancestor of another one. That can be done by verifying that all version stamps are less than or equal to the other one.
 * [s0, 1][s1, 1] is an ancestor of [s0, 1][s1, 2] -&gt; no conflict.
 * [s0, 1] is not an ancestor of [s1, 1] -&gt; conflict needs to be resolved.</p>
<p>This conflict resolution technique comes with trade-offs:
 * Client complexity is increased as clients need to resolve conflicts.
 * Vector clocks can grow rapidly, increasing the memory footprint of each key-value pair.</p>
<h1 id="handling-failures">Handling failures</h1>
<p>At a large enough scale, failures are inevitable. It is important to determine your error detection &amp; resolution strategies.</p>
<h2 id="failure-detection">Failure detection</h2>
<p>In a distributed system, it is insufficient to conclude that a server is down just because you can't reach it. You need at least another source of information.</p>
<p>One approach to do that is to use all-to-all multi-casting. This, however, is inefficient when there are many servers in the system.
<img alt="multicasting" src="images/multicasting.png" /></p>
<p>A better solution is to use a decentralized failure detection mechanism, such as a gossip protocol:
 * Each node maintains a node membership list with member IDs and heartbeat counters.
 * Each node periodically increments its heartbeat counter
 * Each node periodically sends heartbeats to a random set of other nodes, which propagate it onwards.
 * Once a node receives a heartbeat, its membership list is updated.
 * If a heartbeat is not received after a given threshold, the member is marked offline.</p>
<p><img alt="gossip-protocol" src="images/gossip-protocol.png" /></p>
<p>In the above scenario, s0 detects that s2 is down as no heartbeat is received for a long time. 
It propagates that information to other nodes which also verify that the heartbeat hasn't been updated.
Hence, s2 is marked offline.</p>
<h2 id="handling-temporary-failures">Handling temporary failures</h2>
<p>A nice little trick to improve availability in the event of failures is hinted handoff.</p>
<p>What it means is that if a server if temporarily offline, you can promote another healthy service in its place to process data temporarily.
After the server is back online, the data &amp; control is handed back to it.</p>
<h2 id="handling-permanent-failures">Handling permanent failures</h2>
<p>Hinted handoff is used when the failure is intermittent.</p>
<p>If a replica is permanently unavailable, we implement an anti-entropy protocol to keep the replicas in-sync.</p>
<p>This is achieved by leveraging merkle trees in order to reduce the amount of data transmitted and compared to a minimum.</p>
<p>The merkle tree works by building a tree of hashes where leaf nodes are buckets of key-value pairs.</p>
<p>If any of the buckets across two replicas is different, then the merkle tree's hashes will be different all the way to the root:
<img alt="merkle-tree" src="images/merkle-tree.png" /></p>
<p>Using merkle trees, two replicas will compare only as much data as is different between them, instead of comparing the entire data set.</p>
<h2 id="handling-data-center-outage">Handling data center outage</h2>
<p>A data center outage could happen due to a natural disaster or serious hardware failure.</p>
<p>To ensure resiliency, make sure your data is replicated across multiple data centers.</p>
<h1 id="system-architecture-diagram">System architecture diagram</h1>
<p><img alt="architecture-diagram" src="images/architecture-diagram.png" /></p>
<p>Main features:
 * Clients communicate with the key-value store through a simple API
 * A coordinator is a proxy between the clients and the key-value store
 * Nodes are distributed on the ring using consistent hashing
 * System is decentralized, hence adding and removing nodes is supported and can be automated
 * Data is replicated at multiple nodes
 * There is no single point of failure</p>
<p>Some of the tasks each node is responsible for:
<img alt="node-responsibilities" src="images/node-responsibilities.png" /></p>
<h2 id="write-path">Write path</h2>
<p><img alt="write-path" src="images/write-pth.png" />
 * Write requests are persisted in a commit log
 * Data is saved in the memory cache
 * When memory cache is full or reaches a given threshold, data is flushed to an SSTable on disk</p>
<p>SSTable == Sorted String Table. Holds a sorted list of key-value pairs.</p>
<h2 id="read-path">Read path</h2>
<p>Read path when data is in memory:
<img alt="read-path-in-memory" src="images/read-path-in-memory.png" /></p>
<p>Read path when data is not in memory:
<img alt="read-path-not-in-memory" src="images/read-path-not-in-memory.png" />
 * If data is in memory, fetch it from there. Otherwise, find it in the SSTable.
 * A bloom filter is used for efficient lookup in the SSTable.
 * The SSTables returns the resulting data, which is returned to the client</p>
<h1 id="summary">Summary</h1>
<p>We covered a lot of concepts and techniques, here's a summary:
| Goal/Problems               | Technique                                             |
|-----------------------------|-------------------------------------------------------|
| Ability to store big data   | Use consistent hashing to spread load across servers  |
| High availability reads     | Data replication Multi-datacenter setup               |
| Highly available writes     | Versioning and conflict resolution with vector clocks |
| Dataset partition           | Consistent Hashing                                    |
| Incremental scalability     | Consistent Hashing                                    |
| Heterogeneity               | Consistent Hashing                                    |
| Tunable consistency         | Quorum consensus                                      |
| Handling temporary failures | Sloppy quorum and hinted handoff                      |
| Handling permanent failures | Merkle tree                                           |
| Handling data center outage | Cross-datacenter replication                          |</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": [], "search": "../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.92b07e13.min.js"></script>
      
    
  </body>
</html>